{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Plot InSAR, GPS and seismicity data\n",
    "Assumes that the data are located in  `$SCRATCHDIR` (e.g.  `$SCRATCHDIR/MaunaLoaSenDT87/mintpy`).\n",
    "Output is  written into  `$SCRATCHDIR/MaunaLoa/SenDT87` and `$SCRATCHDIR/MaunaLoa/SenAT124`\n",
    "\n",
    "Run all cells of this notebook for an example. The  plot options can be changed by editing the last `cmd = plot_data.py ...`  in the  cell of the `main` functions. Use -`-save-gbis` to save as GBIS files."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {
    "editable": true,
    "slideshow": {
     "slide_type": ""
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "import os\n",
    "import sys\n",
    "import urllib\n",
    "import csv\n",
    "import glob\n",
    "import re\n",
    "import time\n",
    "import datetime\n",
    "import requests\n",
    "import numpy as np\n",
    "import pandas as pd\n",
    "from pandas import concat\n",
    "from pandas import DataFrame\n",
    "from pathlib import Path\n",
    "from dateutil.relativedelta import relativedelta\n",
    "import matplotlib as mpl\n",
    "import matplotlib.pyplot as plt\n",
    "from matplotlib.backends.backend_pdf import PdfPages\n",
    "from matplotlib.colors import LinearSegmentedColormap\n",
    "import cartopy.crs as ccrs\n",
    "import cartopy.feature as cfeature\n",
    "import contextily as ctx\n",
    "import scipy.io as sio\n",
    "from sklearn import datasets, linear_model\n",
    "from datetime import datetime, timezone\n",
    "from mintpy.utils import readfile, writefile, utils as ut\n",
    "from mintpy.defaults.plot import *\n",
    "from mintpy.objects.gps import search_gps, GPS\n",
    "from mintpy.objects import sensor\n",
    "from mintpy.view import prep_slice, plot_slice\n",
    "from mintpy.cli import view, timeseries2velocity, reference_point, asc_desc2horz_vert, save_gdal, mask\n",
    "from utils.helper_functions import is_jupyter, create_parser, cmd_line_parse, get_file_names\n",
    "from utils.helper_functions import prepend_scratchdir_if_needed, find_nearest_start_end_date\n",
    "from utils.helper_functions import get_data_type, get_dem_extent, save_gbis_plotdata\n",
    "from utils.plot_functions import get_basemap, plot_shaded_relief\n",
    "from utils.plot_functions import modify_colormap, add_colorbar\n",
    "from utils.seismicity import get_earthquakes, normalize_earthquake_times\n",
    "from utils.gps import get_gps\n",
    "from utils.insar import generate_view_velocity_cmd, generate_view_ifgram_cmd\n",
    "import subprocess\n",
    "\n",
    "# %load_ext jupyter_ai\n",
    "if 'ipykernel' in sys.modules:\n",
    "    from IPython import get_ipython\n",
    "    ipython = get_ipython()\n",
    "    if 'autoreload' not in ipython.extension_manager.loaded:\n",
    "        ipython.magic('load_ext autoreload')\n",
    "        ipython.magic('autoreload 2')\n",
    "else:\n",
    "    pass"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [],
   "source": [
    "def run_prepare(inps):\n",
    "    # Prepare data for plotting\n",
    "    # Hardwired: move to argparse\n",
    "    inps.depth_range=\"0 10\"\n",
    "    inps.cmap_name = \"plasma_r\"; inps.exclude_beginning = 0.2; inps.exclude_end = 0.2\n",
    "    \n",
    "    # Hardwired for Hawaii\n",
    "    if 'GPSDIR' in os.environ:\n",
    "        inps.gps_dir = os.getenv('GPSDIR') + '/data'\n",
    "    else:\n",
    "        inps.gps_dir = os.getenv('SCRATCHDIR') + '/MaunaLoa/MLtry/data'\n",
    "    \n",
    "    print('run_prepare: inps.gps_dir:' , inps.gps_dir)\n",
    "    inps.gps_list_file = inps.gps_dir + '/GPS_BenBrooks_03-05full.txt'\n",
    "    inps.dem_file = inps.gps_dir + '/demGeo.h5'  \n",
    "\n",
    "    data_dir = inps.data_dir\n",
    "    gps_dir = inps.gps_dir\n",
    "    gps_list_file = inps.gps_list_file\n",
    "    dem_file =  inps.dem_file\n",
    "    plot_box = inps.plot_box\n",
    "    flag_seismicity = inps.flag_seismicity\n",
    "    flag_gps = inps.flag_gps\n",
    "    plot_type = inps.plot_type\n",
    "    line_file = inps.line_file\n",
    "    gps_scale_fac = inps.gps_scale_fac\n",
    "    gps_key_length = inps.gps_key_length\n",
    "    gps_unit = inps.gps_unit\n",
    "    unit = inps.unit\n",
    "    font_size = inps.font_size\n",
    "    reference_lalo = inps.reference_lalo\n",
    "    mask_vmin = inps.mask_vmin\n",
    "    vlim = inps.vlim\n",
    "    flag_save_gbis =  inps.flag_save_gbis\n",
    "    start_date = inps.period[0]\n",
    "    end_date = inps.period[1]\n",
    "\n",
    "    # calculate velocities for periods of interest\n",
    "    data_dict = {}\n",
    "    if plot_type == 'velocity' or plot_type == 'horzvert':\n",
    "        for dir in data_dir:\n",
    "            work_dir = prepend_scratchdir_if_needed(dir)\n",
    "            eos_file, geo_vel_fie, geo_geometry_file, out_dir, out_geo_vel_file = get_file_names(work_dir)\n",
    "            temp_coh_file=out_geo_vel_file.replace('velocity.h5','temporalCoherence.tif')\n",
    "            start_date_mod, end_date_mod = find_nearest_start_end_date(eos_file, start_date, end_date)\n",
    "            # get masked geo_velocity.h5 with MintPy\n",
    "            # cmd = f'{eos_file} --start-date {start_date_mod} --end-date {end_date_mod} --output {out_geo_vel_file}'\n",
    "            # timeseries2velocity.main( cmd.split() )\n",
    "            cmd = f'{eos_file} --start-date {start_date_mod} --end-date {end_date_mod} --output {out_geo_vel_file}'\n",
    "            cmd =['timeseries2velocity.py'] + cmd.split()\n",
    "            output = subprocess.check_output(cmd)\n",
    "            #print(output.decode())\n",
    "            cmd = f'{eos_file} --dset temporalCoherence --output {temp_coh_file}'\n",
    "            save_gdal.main( cmd.split() )\n",
    "            cmd = f'{out_geo_vel_file} --mask {temp_coh_file} --mask-vmin { mask_vmin} --outfile {out_geo_vel_file}'\n",
    "            mask.main( cmd.split() )\n",
    "\n",
    "            timeseries2velocity\n",
    "            \n",
    "            gdal_inps = Namespace(fname=eos_file, dset='temporalCoherence', output=temp_coh_file)\n",
    "            save_gdal(gdal_inps)\n",
    "            mask_file(fname=out_geo_vel_file, mask=temp_coh_file, mask_vmin=mask_vmin, outfile=out_geo_vel_file)\n",
    "    \n",
    "            if reference_lalo:\n",
    "                cmd = f'{out_geo_vel_file} --lat {reference_lalo[0]} --lon {reference_lalo[1]}'\n",
    "                reference_point.main( cmd.split() )\n",
    "            if flag_save_gbis:\n",
    "                save_gbis_plotdata(eos_file, out_geo_vel_file, start_date_mod, end_date_mod)\n",
    "            data_dict[out_geo_vel_file] = {\n",
    "            'start_date': start_date_mod,\n",
    "            'end_date': end_date_mod\n",
    "            }\n",
    "    elif plot_type == 'step':\n",
    "        for dir in data_dir:\n",
    "            work_dir = prepend_scratchdir_if_needed(dir)\n",
    "            eos_file, geo_vel_file, geo_geometry_file, out_dir, out_geo_vel_file = get_file_names(work_dir)\n",
    "            geo_step, atr = readfile.read(geo_vel_file, datasetName='step20210306')\n",
    "            out_geo_step_file = out_geo_vel_file.replace('velocity','step')\n",
    "            writefile.write(geo_step, out_file=out_geo_step_file, metadata=atr)\n",
    "            if reference_lalo:\n",
    "                cmd = f'{out_geo_step_file} --lat {reference_lalo[0]} --lon {reference_lalo[1]}'\n",
    "                reference_point.main( cmd.split() )\n",
    "            data_dict[out_geo_step_file] = {\n",
    "            'start_date': atr['mintpy.timeFunc.stepDate'],\n",
    "            'end_date': atr['mintpy.timeFunc.stepDate']\n",
    "            }\n",
    "    elif plot_type == 'shaded-relief':\n",
    "        data_dict[dem_file] = {\n",
    "        'start_date': start_date,\n",
    "        'end_date': end_date\n",
    "        }\n",
    " \n",
    "    # calculate horizontal and vertical\n",
    "    if  plot_type == 'horzvert':\n",
    "        data_dict = {}\n",
    "        q, q, q, q, out_geo_vel_file0 = get_file_names( prepend_scratchdir_if_needed(data_dir[0]) )\n",
    "        q, q, q, q, out_geo_vel_file1 = get_file_names( prepend_scratchdir_if_needed(data_dir[1]) )\n",
    "        \n",
    "        cmd = f'{out_geo_vel_file0} {out_geo_vel_file1}'\n",
    "        asc_desc2horz_vert.main( cmd.split() )\n",
    "        data_dict['up.h5'] = {'start_date': start_date, 'end_date': end_date}\n",
    "        data_dict['hz.h5'] = {'start_date': start_date, 'end_date': end_date}\n",
    "    return data_dict"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {
    "editable": true,
    "jp-MarkdownHeadingCollapsed": true,
    "scrolled": true,
    "slideshow": {
     "slide_type": ""
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Command: ['plot_data.py', 'MaunaLoaSenDT87/mintpy_5_20', '--plot-type', 'shaded-relief', '--plot-box', '19.43:19.5,-155.62:-155.55', '--seismicity']\n",
      "iargs ['MaunaLoaSenDT87/mintpy_5_20', '--plot-type', 'shaded-relief', '--plot-box', '19.43:19.5,-155.62:-155.55', '--seismicity']\n",
      "cmd_line_parse: iargs: ['MaunaLoaSenDT87/mintpy_5_20', '--plot-type', 'shaded-relief', '--plot-box', '19.43:19.5,-155.62:-155.55', '--seismicity']\n",
      "cmd_line_parse: parser: ArgumentParser(prog='plot_data.py', usage=None, description='Plotting of InSAR, GPS and Seismicity data', formatter_class=<class 'argparse.HelpFormatter'>, conflict_handler='error', add_help=True)\n",
      "cmd_line_parse: args: Namespace(data_dir=['MaunaLoaSenDT87/mintpy_5_20'], plot_box='19.43:19.5,-155.62:-155.55', period='20220101-20221101', flag_seismicity=True, flag_gps=False, plot_type='shaded-relief', line_file='/Users/famelung/code/rsmas_insar/tools/plotdata/data/hawaii_lines_new.mat', gps_scale_fac=500, gps_key_length=4, gps_unit='cm', unit='cm', font_size=12, reference_lalo=False, mask_vmin=0.7, vlim=None, flag_save_gbis=False)\n",
      "cmd_line_parse: args.plot_box: 19.43:19.5,-155.62:-155.55\n",
      "cmd_line_parse: inps.plot_box: 19.43:19.5,-155.62:-155.55\n",
      "inps: Namespace(data_dir=['MaunaLoaSenDT87/mintpy_5_20'], plot_box=[19.43, 19.5, -155.62, -155.55], period=['20220101', '20221101'], flag_seismicity=True, flag_gps=False, plot_type='shaded-relief', line_file='/Users/famelung/code/rsmas_insar/tools/plotdata/data/hawaii_lines_new.mat', gps_scale_fac=500, gps_key_length=4, gps_unit='cm', unit='cm', font_size=12, reference_lalo=False, mask_vmin=0.7, vlim=None, flag_save_gbis=False)\n",
      "run_prepare: inps.gps_dir: /Users/famelung/onedrive/scratch/MaunaLoa/MLtry/data\n"
     ]
    },
    {
     "ename": "NameError",
     "evalue": "name 'run_plot' is not defined",
     "output_type": "error",
     "traceback": [
      "\u001b[0;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[0;31mNameError\u001b[0m                                 Traceback (most recent call last)",
      "Cell \u001b[0;32mIn[3], line 40\u001b[0m\n\u001b[1;32m     37\u001b[0m     sys\u001b[38;5;241m.\u001b[39margv \u001b[38;5;241m=\u001b[39m cmd\u001b[38;5;241m.\u001b[39msplit()\n\u001b[1;32m     39\u001b[0m \u001b[38;5;28mprint\u001b[39m(\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mCommand:\u001b[39m\u001b[38;5;124m'\u001b[39m,sys\u001b[38;5;241m.\u001b[39margv)\n\u001b[0;32m---> 40\u001b[0m data_dict, inps, sys\u001b[38;5;241m.\u001b[39margv \u001b[38;5;241m=\u001b[39m \u001b[43mmain\u001b[49m\u001b[43m(\u001b[49m\u001b[43msys\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43margv\u001b[49m\u001b[43m[\u001b[49m\u001b[38;5;241;43m1\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m]\u001b[49m\u001b[43m)\u001b[49m\n",
      "Cell \u001b[0;32mIn[3], line 7\u001b[0m, in \u001b[0;36mmain\u001b[0;34m(iargs)\u001b[0m\n\u001b[1;32m      5\u001b[0m \u001b[38;5;28mprint\u001b[39m(\u001b[38;5;124m'\u001b[39m\u001b[38;5;124minps:\u001b[39m\u001b[38;5;124m'\u001b[39m,inps)\n\u001b[1;32m      6\u001b[0m data_dict \u001b[38;5;241m=\u001b[39m run_prepare(inps)\n\u001b[0;32m----> 7\u001b[0m \u001b[43mrun_plot\u001b[49m(data_dict, inps)\n\u001b[1;32m      9\u001b[0m \u001b[38;5;66;03m# return data_dict, inps, iargs\u001b[39;00m\n\u001b[1;32m     10\u001b[0m \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m, \u001b[38;5;28;01mNone\u001b[39;00m, \u001b[38;5;28;01mNone\u001b[39;00m\n",
      "\u001b[0;31mNameError\u001b[0m: name 'run_plot' is not defined"
     ]
    }
   ],
   "source": [
    "def main(iargs=None):\n",
    "    os.chdir(os.getenv('SCRATCHDIR'))\n",
    "    print('iargs', iargs)\n",
    "    inps = cmd_line_parse(iargs)    \n",
    "    print('inps:',inps)\n",
    "    data_dict = run_prepare(inps)\n",
    "    run_plot(data_dict, inps)\n",
    "    \n",
    "    # return data_dict, inps, iargs\n",
    "    return None, None, None\n",
    "###########################################################################################\n",
    "\n",
    "if __name__ == '__main__':\n",
    "    if is_jupyter():\n",
    "        # in Jupyter, assign command line args to sys.argv\n",
    "        cmd = 'plot_data.py --help'\n",
    "        cmd = 'plot_data.py MaunaLoaSenDT87 --plot-type ifgram --seismicity --GPS'\n",
    "        cmd = 'plot_data.py MaunaLoaSenDT87 --plot-type shaded_relief --seismicity --GPS'\n",
    "        cmd = 'plot_data.py MaunaLoaSenAT124 MaunaLoaSenDT87 --noseismicity --GPS'\n",
    "        cmd = 'plot_data.py MaunaLoaSenAT124 MaunaLoaSenDT87 --ref-point 19.55,-155.45'\n",
    "        cmd = 'plot_data.py MaunaLoaSenDT87 --plot-type velocity'\n",
    "        cmd = 'plot_data.py MaunaLoaSenDT87/mintpy_5_20 MaunaLoaSenAT124/mintpy_5_20 --plot-type horzvert --ref-point 19.55,-155.45 --mask-thresh 0.9'\n",
    "        cmd = 'plot_data.py MaunaLoaSenDT87/mintpy_5_20 MaunaLoaSenAT124/mintpy_5_20 --plot-type horzvert --ref-point 19.55,-155.45 --period 20220801-20221127 --plot-box 19.43:19.5,-155.62:-155.55 --vlim -5 5 --save-gbis'\n",
    "        cmd = 'plot_data.py --help'\n",
    "        cmd = 'plot_data.py MaunaLoaSenDT87/mintpy_5_20 MaunaLoaSenAT124/mintpy_5_20 --plot-type velocity --ref-point 19.55,-155.45 --period 20220801-20221127 --vlim -20 20 --save-gbis --GPS --seismicity --fontsize 14'\n",
    "        cmd = 'plot_data.py MaunaLoaSenDT87/mintpy_5_20  --plot-type shaded-relief --GPS --GPS-scale-fac 200 --GPS-key-length 1'\n",
    "        cmd = 'plot_data.py MaunaLoaSenDT87/mintpy_5_20  --plot-type shaded-relief --GPS --seismicity'\n",
    "        cmd = 'plot_data.py GalapagosSenDT128/mintpy  --plot-type=velocity --plot-box=-0.52:-0.28,-91.7:-91.4 --period=20200131-20231231 --GPS --seismicity'\n",
    "        cmd = 'plot_data.py GalapagosSenDT128/mintpy GalapagosSenAT106/mintpy_orig  --plot-type=horzvert --plot-box=-1.0:-0.75,-91.55:-91.25 --period=20190101-20230801 --vlim -5 5'\n",
    "        cmd = 'plot_data.py GalapagosSenDT128/mintpy GalapagosSenAT106/mintpy_orig  --plot-type=horzvert --plot-box=-1.0:-0.75,-91.55:-91.25 --period=20220101-20230831 --vlim -5 5'\n",
    "        cmd = 'plot_data.py MaunaLoaSenDT87/mintpy_5_20  --plot-type shaded-relief --plot-box 19.43:19.5,-155.62:-155.55  --seismicity'\n",
    "\n",
    "        # replace multiple spaces with a single space, remove trailing space\n",
    "        cmd = re.sub(' +', ' ', cmd) \n",
    "        cmd = cmd.rstrip()\n",
    "    \n",
    "        sys.argv = cmd.split()\n",
    "\n",
    "    print('Command:',sys.argv)\n",
    "    data_dict, inps, sys.argv = main(sys.argv[1:])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "editable": true,
    "slideshow": {
     "slide_type": ""
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# # DEBUG CELL: uncomment for access to inps, data_dict \n",
    "# def main(iargs=None):\n",
    "#     print('iargs', iargs)\n",
    "#     inps = cmd_line_parse(iargs)    \n",
    "#     print('inps:',inps)\n",
    "#     data_dict = run_prepare(inps)\n",
    "#     run_plot(data_dict, inps)  \n",
    "#     return data_dict, inps, iargs\n",
    "\n",
    "# cmd = 'plot_data.py MaunaLoaSenDT87/mintpy_2_8_step  MaunaLoaSenAT124/mintpy_2_8_step --plot-type step --period 20201001-20210306 --ref-point 19.475,-155.6 --plot-box 19.43:19.5,-155.62:-155.55 --vlim -6 6'\n",
    "# print(cmd)\n",
    "# sys.argv = cmd.split()\n",
    "# data_dict, inps, sys.argv = main(sys.argv[1:])  "
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.7"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
